import discord
from discord.ext import commands
import random
import json

TOKEN = "MTMzNDM4NTk1NDI0NDM5NTAxOQ.GeUtz5.3-gNgDi9fBD-xGsSPTFYrR-Hq6TODikf3QF9Gw"

intents = discord.Intents.default()
intents.messages = True
intents.guilds = True
intents.members = True
intents.dm_messages = True  # DM ê¸°ëŠ¥ í™œì„±í™”

bot = commands.Bot(command_prefix="!", intents=intents)

# ë³µê¶Œ ë°ì´í„° ì €ì¥ (JSON íŒŒì¼ ì‚¬ìš©)
LOTTERY_FILE = "lottery.json"
TOTAL_TICKETS = 100  # ë³µê¶Œ ë²ˆí˜¸ ë²”ìœ„ (1~100)

# ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
def load_data():
    try:
        with open(LOTTERY_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

# ë°ì´í„° ì €ì¥ í•¨ìˆ˜
def save_data(data):
    with open(LOTTERY_FILE, "w") as f:
        json.dump(data, f, indent=4)

# ì‚¬ìš©ëœ ëª¨ë“  ë³µê¶Œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
def get_used_numbers(data):
    return {num for tickets in data.values() for num in tickets}

# ë³µê¶Œ ì§€ê¸‰ ëª…ë ¹ì–´ (ë²ˆí˜¸ ì„ íƒ ê°€ëŠ¥, DM ì „ì†¡)
@bot.command()
async def ë³µê¶Œì§€ê¸‰(ctx, member: discord.Member, number: int = None):
    data = load_data()
    user_id = str(member.id)

    if user_id not in data:
        data[user_id] = []

    if len(data[user_id]) >= 5:
        await ctx.send(f"{member.mention} ë‹˜ì€ ì´ë¯¸ ìµœëŒ€ 5ì¥ì˜ ë³µê¶Œì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!")
        return

    used_numbers = get_used_numbers(data)

    # ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì§€ ì•Šì€ ê²½ìš° ìë™ ë²ˆí˜¸ ë°°ì •
    if number is None:
        available_numbers = list(set(range(1, TOTAL_TICKETS + 1)) - used_numbers)
        if not available_numbers:
            await ctx.send("ëª¨ë“  ë³µê¶Œ ë²ˆí˜¸ê°€ ì´ë¯¸ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ˜¥")
            return
        number = random.choice(available_numbers)

    # ì´ë¯¸ ì‚¬ìš©ëœ ë²ˆí˜¸ì¸ì§€ í™•ì¸
    if number in used_numbers:
        await ctx.send(f"âŒ {number}ë²ˆì€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤! ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.")
        return

    data[user_id].append(number)
    save_data(data)

    # DMìœ¼ë¡œ ë³µê¶Œ ë²ˆí˜¸ ì „ì†¡
    try:
        await member.send(f"ğŸŸï¸ [ë””ìŠ¤ì½”ë“œ ë³µê¶Œ ì•Œë¦¼] ğŸŸï¸\n\n"
                          f"âœ… {member.display_name} ë‹˜ì˜ ë³µê¶Œ ë²ˆí˜¸: **{number}**\n"
                          f"ğŸ“¢ ì¶”ì²¨ ë‚ ì§œ: ë§¤ì›” ë§ì¼!\n"
                          f"ğŸ”— ë‹¹ì²¨ ê²°ê³¼ëŠ” ì„œë²„ì—ì„œ í™•ì¸í•˜ì„¸ìš”!")
        await ctx.send(f"{member.mention} ë‹˜ì˜ ë³µê¶Œ ë²ˆí˜¸ê°€ **DMìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!** âœ‰ï¸")
    except discord.Forbidden:
        await ctx.send(f"âŒ {member.mention} ë‹˜ì˜ DMì´ ì°¨ë‹¨ë˜ì–´ ìˆì–´ ë³µê¶Œ ë²ˆí˜¸ë¥¼ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! "
                       f"ì„œë²„ ì±„íŒ…ì—ì„œ `!ë³µê¶Œí™•ì¸` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.")

# ë³µê¶Œ í™•ì¸ ëª…ë ¹ì–´ (DMìœ¼ë¡œ ì „ì†¡)
@bot.command()
async def ë³µê¶Œí™•ì¸(ctx, member: discord.Member = None):
    data = load_data()
    member = member or ctx.author
    user_id = str(member.id)

    if user_id in data and data[user_id]:
        tickets = ", ".join(map(str, sorted(data[user_id])))
        try:
            await member.send(f"ğŸŸï¸ [ë””ìŠ¤ì½”ë“œ ë³µê¶Œ í™•ì¸] ğŸŸï¸\n\n"
                              f"âœ… {member.display_name} ë‹˜ì˜ ë³´ìœ  ë³µê¶Œ ë²ˆí˜¸: **{tickets}**\n"
                              f"ğŸ“¢ ì¶”ì²¨ ë‚ ì§œ: ë§¤ì›” ë§ì¼!\n"
                              f"ğŸ”— ë‹¹ì²¨ ê²°ê³¼ëŠ” ì„œë²„ì—ì„œ í™•ì¸í•˜ì„¸ìš”!")
            await ctx.send(f"{member.mention} ë‹˜ì˜ ë³µê¶Œ ë²ˆí˜¸ê°€ **DMìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!** âœ‰ï¸")
        except discord.Forbidden:
            await ctx.send(f"âŒ {member.mention} ë‹˜ì˜ DMì´ ì°¨ë‹¨ë˜ì–´ ìˆì–´ ë³µê¶Œ ë²ˆí˜¸ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! "
                           f"ì„œë²„ì—ì„œ `!ë³µê¶Œí™•ì¸` ëª…ë ¹ì–´ë¥¼ ë‹¤ì‹œ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.")
    else:
        await ctx.send(f"{member.mention} ë‹˜ì€ ì•„ì§ ë³µê¶Œì´ ì—†ìŠµë‹ˆë‹¤!")

# ë³µê¶Œ ì¶”ì²¨ ëª…ë ¹ì–´
@bot.command()
async def ë³µê¶Œì¶”ì²¨(ctx):
    data = load_data()
    if not data:
        await ctx.send("ì•„ì§ ë³µê¶Œì„ ê°€ì§„ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤!")
        return

    all_tickets = [(user, ticket) for user, tickets in data.items() for ticket in tickets]
    winners = random.sample(all_tickets, min(3, len(all_tickets)))

    winner_msgs = [
        f"ğŸ¥‡ **1ë“±:** <@{winners[0][0]}> ğŸŸï¸ {winners[0][1]}",
        f"ğŸ¥ˆ **2ë“±:** <@{winners[1][0]}> ğŸŸï¸ {winners[1][1]}" if len(winners) > 1 else "",
        f"ğŸ¥‰ **3ë“±:** <@{winners[2][0]}> ğŸŸï¸ {winners[2][1]}" if len(winners) > 2 else "",
    ]
    
    await ctx.send("ğŸ° **ë³µê¶Œ ì¶”ì²¨ ê²°ê³¼ ë°œí‘œ!** ğŸ°\n" + "\n".join(winner_msgs))

# ë³µê¶Œ ì‹œë®¬ë ˆì´ì…˜ ëª…ë ¹ì–´
@bot.command()
async def ë³µê¶Œì‹œë®¬ë ˆì´ì…˜(ctx):
    data = load_data()
    if not data:
        await ctx.send("ì•„ì§ ë³µê¶Œì„ ê°€ì§„ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤! ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    all_tickets = [(user, ticket) for user, tickets in data.items() for ticket in tickets]
    simulated_winners = random.sample(all_tickets, min(3, len(all_tickets)))

    sim_msgs = [
        f"ğŸ”® **1ë“± (ì‹œë®¬ë ˆì´ì…˜):** <@{simulated_winners[0][0]}> ğŸŸï¸ {simulated_winners[0][1]}",
        f"ğŸ”® **2ë“± (ì‹œë®¬ë ˆì´ì…˜):** <@{simulated_winners[1][0]}> ğŸŸï¸ {simulated_winners[1][1]}" if len(simulated_winners) > 1 else "",
        f"ğŸ”® **3ë“± (ì‹œë®¬ë ˆì´ì…˜):** <@{simulated_winners[2][0]}> ğŸŸï¸ {simulated_winners[2][1]}" if len(simulated_winners) > 2 else "",
    ]
    
    await ctx.send("ğŸ° **ë³µê¶Œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ (ì—°ìŠµìš©)** ğŸ°\n" + "\n".join(sim_msgs))

# ë´‡ ì‹¤í–‰
bot.run(TOKEN)
